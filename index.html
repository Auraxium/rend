<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Lo Player v5</title>
	<!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">-->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css" />
	<script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk="
		crossorigin="anonymous"></script>
	<style type="text/css">
		.disclaimer {
			display: none;
		}
	</style>
	<script type="application/javascript">
		document.insertCohort = null;
	</script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.0.0-alpha.1/axios.min.js"></script>
	<script src="https://apis.google.com/js/api.js"></script>
	<!-- <script defer src="main.js"></script>
	<link defer rel="stylesheet" href="style.css"> -->
</head>

<body>
	<!--CSS-->
	<style>
		/*#region Junk*/

		body {
			margin: 0;
			padding: 0;

			height: 100vh;
			width: 100vw;

			/* overflow: hidden; */

			background-color: rgb(12, 12, 12);

			font-family: 'Helvetica', 'neue', sans-serif;
		}

		* {
			box-sizing: border-box;
			color: white;

			-webkit-touch-callout: none;
			-webkit-user-select: none;
			-khtml-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
		}

		::-webkit-scrollbar {
			display: none;
		}

		/*#endregion */

		/*#region MAIN */

		.app {
			height: 100vh;
			width: 100vw;

			display: flex;
			flex-direction: column;
		}

		.nav {
			background-color: lime;

			display: flex;
			flex-wrap: nowrap;
			flex-direction: row;
			justify-content: space-between;
			align-content: center;
		}

		.nav-mobile {
			display: none;

		}

		.main-container {
			flex: 70;
			overflow: hidden;
			display: flex;
		}

		.container {
			display: flex;
			flex-direction: column;
			flex-wrap: nowrap;
			flex: auto;
		}

		.left {
			flex: 15;
			min-width: 15%;
			max-width: 15%;

			overflow: scroll;
			border-style: solid;
			border-width: 2px;
			height: 100%;
		}

		.right {
			flex: 15;
			min-width: 15%;
			max-width: 15%;

			height: 100%;
			border-style: solid;
			border-width: 2px;
			overflow: hidden;
		}

		.song-scope {
			display: flex;
			flex-direction: column;
		}

		.display {
			display: flex;
			flex-direction: column;
			overflow: scroll;
		}

		.accept-menu {
			width: 100%;
			height: 100px;
			background-color: #04aa6d;

			display: flex;
			justify-content: space-between;
			align-items: center;
			display: none;
		}

		.queue-list-container {
			height: 100%;
			display: flex;
			flex-direction: column;
			overflow: scroll;
		}

		.queue-list {
			display: flex;
			flex-direction: column;
		}

		.selected {
			background-color: lightgreen;
		}

		#choose {
			display: inline-block;
			width: 200px;
		}

		.playlist {
			background-color: rgb(33, 33, 33);
			padding: 5px;
			height: 50px;
			display: flex;
			align-items: center;
		}



		.playlist:hover {
			background-color: rgb(58, 58, 58);
		}

		.playlist.selected {
			background-color: rgb(14, 129, 12);
		}

		.playlist-form {
			display: flex;
			flex-direction: column;
		}

		.playlist-list {
			display: flex;
			flex-direction: column-reverse;
		}

		.song {
			background-color: rgb(33, 33, 33);
			padding: 5px;
			/* max-width: 100%; */

			display: flex;
			flex-direction: row;
			align-items: center;
			justify-content: space-between;
		}

		.song>* {
			/* overflow: hidden; */
			/* border: 1px solid; */
		}

		.song-num {
			flex: 3;
			text-align: center;
		}

		.song-name {
			flex: 87;
			margin-left: 3px;
			white-space: nowrap;
			/* overflow: hidden; */
			text-overflow: ellipsis;
		}

		.song-img {
			flex: 5;
			margin-left: 3px;
		}

		.song-dots {
			flex: 5;
			text-align: end;
			font-size: 10px;
		}

		.song-text {
			width: 200px;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
		}

		.song:hover {
			background-color: rgb(58, 58, 58);
		}

		.song.highlight {
			background-color: rgb(164, 164, 164);
		}

		.song.playing {
			background-color: rgb(38, 30, 151);
		}

		.song.selected {
			background-color: rgb(14, 129, 12);
		}

		.selected {
			background-color: rgb(14, 129, 12);
		}

		#choose {
			overflow-y: scroll;
			height: 300px;
		}

		.ce {
			background-color: rgb(33, 33, 33);
			padding: 5px;
			height: 50px;
			display: flex;
			align-items: center;
		}

		.ce:hover {
			background-color: rgb(58, 58, 58);
		}

		/*#endregion */

		/*#region PART2*/
		.crop {
			/* max-height: 50px; */
			max-width: 50px;
			min-height: 50px;
			/* ;
			min-width: 50px; */
			/* height: 50px; */
			/* width: 50px; */
			/* border: 1px solid black; */
			/* aspect-ratio: 1; */
			background-position: center;
			background-size: cover;
		}

		.tabs>div {
			padding: 3px 10px;
			background-color: #d3d3d3;
		}

		.form {}

		#sng {
			max-height: 200px;
			max-width: 355px;
			aspect-ratio: 16/9;
		}

		.tools {
			min-width: 40%;
		}

		.tools2 {
			display: flex;
			align-items: center;
			justify-content: space-between;
		}

		.accept-menu {
			display: flex;
			justify-content: space-between;
			text-align: center;
		}

		.queue-lable {
			display: flex;
			justify-content: center;
			align-items: center;
		}

		row {
			display: flex;
			align-items: center;
		}

		.row {
			display: flex;
			align-items: center;
		}

		.col {
			display: flex;
			flex-direction: column;
		}

		/* .bi-three-dots {
			font-size: 30px;
			z-index: 3;
		} */

		.bi-three-dots:hover {
			background-color: gainsboro;
		}

		.bim {
			font-size: 30px;
		}

		.dropdown-menu {
			position: absolute;
			margin: 0, 30px;
			background-color: rgb(44, 44, 44);
			padding: 0.75rem;
			border-radius: 0.25rem;
			box-shadow: 0 2px 5px 0 rgba(0, 0, 0, 0.1);
			max-width: 200px;
			z-index: 100;
			top: 0;
			left: 0;

			display: none;
		}

		.dd-options>div {
			padding: 5px;
			font-size: 17px;
		}

		.dd-options>div:hover {
			background-color: rgb(101, 38, 38);
		}


		.add-song-form {
			position: absolute;
			display: flex;
			flex-direction: column;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			padding: 7px;
			background-color: rgb(44, 44, 44);
			width: auto;
			max-width: 50vh;

			height: auto;

			overflow: scroll;

			/* height: 75%; */
			/* width: 75%; */

			display: none;
			z-index: 2;
		}

		.test-player {
			display: none;
		}

		.form-option {
			font-size: 25px;
			margin: 10px 5px;
			padding: 4px;
		}


		.form-blur {
			position: absolute;
			background-color: black;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			z-index: 1;

			opacity: 0.8;
			display: none;
		}

		.misc-form {
			position: absolute;
			display: flex;
			flex-direction: column;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			padding: 7px;
			background-color: rgb(44, 44, 44);
			/* width: auto; */
			width: 80vw;
			max-width: 80vw;
			max-height: 80vh;

			height: auto;

			overflow: scroll;

			/* height: 75%; */
			/* width: 75%; */

			display: none;
			z-index: 2;
		}

		.bi {
			/* font-size: 30px; */
		}

		.float-duration {
			position: absolute;
			background-color: rgb(192, 192, 192);
			color: black;
			padding: 1px 3px;
			font-size: 15px;

			display: flex;
			flex-direction: column;
			justify-content: center;
			align-items: center;

			top: auto;
			left: auto;
			opacity: 0;
			pointer-events: none;
			z-index: 4;
		}

		.float-duration.active {
			opacity: 1;
			pointer-events: auto;
		}

		.float-volume {
			position: absolute;
			background-color: rgb(192, 192, 192);
			color: black;
			padding: 1px 3px;
			font-size: 15px;

			display: flex;
			flex-direction: column;
			justify-content: center;
			align-items: center;

			top: auto;
			left: auto;
			opacity: 0;
			pointer-events: none;
			z-index: 4;
		}

		.float-volume.active {
			opacity: 1;
			pointer-events: auto;
		}

		.no-click {
			pointer-events: none;
		}

		.pictest {
			width: 275px;
			height: 275px;
			border: 1px solid black;
			/* background-position: center; */
			/* background-size: cover; */
		}

		.yt-abs {
			position: absolute;
			background-color: #0d0d0d;
			width: 300px;
			min-height: 500px;
			max-height: 500px;

			display: none;
		}

		[mobile-container] {
			display: none;
		}


		/*#endregion */
	</style>

	<!--Foot-->
	<style>
		.foot {
			flex: 10;

			background-color: rgb(15, 37, 15);
			display: flex;
		}

		.foot-mobile-padding {
			display: none;
		}

		.song-info {
			width: 25%;
			padding: 0 5px;
			display: flex;
			align-items: center;
			justify-content: space-between;
		}

		#songInfoName {
			width: 100%;
			display: flex;
			flex-direction: column;
		}

		.footmid {
			width: 50%;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
		}

		#controls {
			font-size: 45px;

			display: flex;
			justify-content: space-around;
			width: 80%;
			max-width: 300px;
		}

		#elapsed {
			flex: 5;
		}

		#length {
			flex: 5;
			text-align: end;
		}

		.duration {
			display: flex;
			justify-content: center;
			align-items: center;
			width: 100%;
		}

		.progress-container {
			background: rgb(117, 117, 117);
			border-radius: 5px;
			cursor: pointer;
			margin: 10px 0;
			height: 12px;
			flex: 90;
		}

		.progress {
			background-color: #fe8daa;
			border-radius: 5px;
			height: 100%;
			width: 0%;
			pointer-events: none;
		}

		.misc {
			width: 25%;
			display: flex;
			align-items: center;
			justify-content: end;
		}

		.buttons {
			font-size: 25px;
			margin: 0px 5px;
			display: flex;
			line-height: 0px;
			flex-wrap: wrap;
		}

		.volume {
			display: flex;
			align-items: center;
		}

		.bi-volume-up {
			font-size: 25px;
			line-height: 5px;
			/*margin: 0 10px 0 0;*/
		}

		.slidecontainer {
			width: 100%;
			max-width: 150px;
			min-width: 100px;
		}

		/* The slider itself */
		.slider {
			-webkit-appearance: none;
			/* Override default CSS styles */
			appearance: none;
			width: 90%;
			/* Full-width */
			height: 15px;
			/* Specified height */
			background: #d3d3d3;
			/* Grey background */
			outline: none;
			/* Remove outline */
			opacity: 0.7;
			/* Set transparency (for mouse-over effects on hover) */
			-webkit-transition: 0.2s;
			/* 0.2 seconds transition on hover */
			transition: opacity 0.2s;
		}

		/* Mouse-over effects */
		.slider:hover {
			opacity: 1;
			/* Fully shown on mouse-over */
		}

		/* The slider handle (use -webkit- (Chrome, Opera, Safari, Edge) and -moz- (Firefox) to override default look) */
		.slider::-webkit-slider-thumb {
			-webkit-appearance: none;
			/* Override default look */
			appearance: none;
			width: 15px;
			/* Set a specific slider handle width */
			height: 15px;
			/* Slider handle height */
			background: #04aa6d;
			/* Green background */
			cursor: pointer;
			/* Cursor on hover */
		}

		.slider::-moz-range-thumb {
			width: 25px;
			/* Set a specific slider handle width */
			height: 25px;
			/* Slider handle height */
			background: #04aa6d;
			/* Green background */
			cursor: pointer;
			/* Cursor on hover */
		}

		.togglable {
			opacity: 0.3;
		}

		.bi-star {}

		.resize {
			font-size: 25px;
			margin: 0px 5px;
			line-height: 0px;
		}
	</style>

	<!-- anis -->
	<style>
		.arc:before {
			-webkit-animation: spin 0.5s infinite linear;
			animation: spin 0.5s infinite linear;
			border-radius: 100%;
			border-top: 6px solid var(--primary, #fff);
			content: "";
			display: block;
			height: 50px;
			width: 50px;
		}

		@-webkit-keyframes spin {
			to {
				-webkit-transform: rotate(360deg);
				transform: rotate(360deg);
			}
		}

		@keyframes spin {
			to {
				-webkit-transform: rotate(360deg);
				transform: rotate(360deg);
			}
		}
	</style>

	<!-- official mobile -->
	<style>
		.app-mobile {
			display: none;
		}
	</style>

	<!-- media queries -->
	<style>
		@media (max-width: 600px) {

			.app {
				display: none;
			}

			/* * {
				overflow: hidden;
			} */

			.app-mobile {
				width: 100vw;
				height: 100vh;
				display: flex;
				flex-direction: column;
				overflow: hidden;
			}

			.app-mobile>* {
				overflow: hidden;
			}

			.nav-mobile {
				flex: 7;
				background-color: #04aa6d;
				padding: 0px 5px;
				display: flex;
				align-items: center;
				justify-content: space-between;
			}

			.mainM {
				flex: 75;
				overflow: hidden;
			}

			.dock-bar {
				flex: 8;
				display: flex;
				justify-content: space-evenly;
				background-color: #0d0d0d;
			}

			.song-bar {
				flex: 10;
				background-color: #04aa6d;
				padding: 0 5px;
			}

			.dock-bar>div {
				flex: 1;
				display: flex;
				flex-direction: column;
				justify-content: flex-end;
				align-items: center;
				justify-content: center;
				padding-top: 2px;
				text-align: center;
				opacity: .5;
				/* border: 1px solid; */
			}

			.dock-bar>div.active {
				opacity: 1;
				/* border: 1px solid; */
			}

			.dock-bar>div>i {
				font-size: 7vw;
			}

			.nm-img {
				padding: 5px;
			}

			.dropdown-menu {
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
			}

			#sb1 {
				height: 100%;
				width: 100%;
				display: flex;
				justify-content: space-between;
				align-items: center;
			}

			#sb2 {
				height: 100%;
				width: 100%;
				display: flex;
				justify-content: center;
				align-items: center;
			}

			.duration {
				height: 100%;
			}

			#elapsed {
				flex: 10;
			}

			#length {
				flex: 10;
			}

			.progress-container {
				flex: 80;
				height: 30%;
			}

			.song-num {
				flex: 10;
			}

			.song-name {
				flex: 65;
				margin-left: 3px;
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
			}

			.song-img {
				flex: 15;
				margin-left: 3px;
			}

			.song-dots {
				flex: 10;
				text-align: end;
				font-size: 2vw;
			}



			/* .progress {
				width: 90%;
				height: 100%;
			} */

			#sv-img {
				height: auto;
				width: 100%;
				object-fit: fill;
			}

		}
	</style>

	<!-- HTML -->

	<div absolutes>
		<div class="add-song-form">
			<div>Name</div>
			<input class="form-option" id="name" />

			<div>Link</div>
			<row>
				<input class="form-option" id="link" style="width: 70%;" />
				<button class="" onclick="yt_auto_fill()" style="width: 30%; height: 40px;">Auto Fill</button>
			</row>

			<row>
				<div>Type</div>
				<select class="form-option" style="background-color: #d3d3d3" id="type">
					<option value="YOUTUBE">Youtube</option>
					<option value="FILE">File</option>
				</select>
			</row>

			<div>
				<div>
					<div>Start Time</div>
					<input class="form-option" value="0" id="startTime" />
				</div>
				<div>
					<div>End Time</div>
					<input class="form-option" id="endTime" />
				</div>
			</div>

			<div id="form_buttons">

			</div>
		</div>

		<div class="misc-form"></div>

		<div class="test-player" id="info_player">

		</div>

		<div class="float-duration">
			<div id="floatDurationElapsed"></div>
		</div>

		<div class="float-volume">
			<div id="floatVolume"></div>
		</div>

		<div class="dropdown-menu" id="context-menu" dropdown_menu>
		</div>

		<div class="dropdown-menu" id="hover-menu">
			<input />
			<div>Create Playlist</div>
			<hr />
			<div class="" id="hover-form-playlists">

			</div>
			<button onclick="selAddToPlaylist(); ">Add</button>
		</div>

		<div class="form-blur" onclick="closeSongForm()" form-blur></div>

		<div class="yt-abs" style="overflow: scroll;">
			<input class="yt-search" onkeydown=" if (event.keyCode == 13) YT_SEARCH(this.value)"></input>
			<button onclick="YT_SEARCH($('.yt-search').val())">Search</button>
			<input class="yt-search" onkeydown="if (event.keyCode == 13) SpotifySearch(this.value)"></input>
			<button onclick="YT_SEARCH($('.yt-search').val())">Spotify</button>
			<div class="yt-vids" style="overflow: scroll;"></div>
		</div>

	</div>

	<div class="app">

		<!-- <div class="test">
			<div class="yes">yes</div>
			<div class="hi">hi</div>
			<div class="hello">hello</div>
		</div>

		<div class="testt">

		</div> -->

		<div class="nav">
			<div>hi</div>
			<button onclick="ytMenu()" tysbut>my</button>
			<button onclick="">name</button>
			<div>is</div>
			<div>
				<input type="file" name="" id="JData" />
			</div>
		</div>

		<div class="main-container">
			<div class="left">
				<div class="" style="text-align: center;">playlists</div>
				<div class="playlist" onclick="openPlaylist(); $('.playlist-tools').hide()">All Songs
				</div>
				<div class="playlist" onclick="openPlaylist('favorites'); $('.playlist-tools').hide()">Favorites</div>
				<button style="width: 100%; margin-top: 5px;" onclick="$('.playlist-form').show()">Create Playlist</button>
				<hr />
				<div class="playlist-form" style="display: none;">
					<input id="playlist_name" />
					<button style="margin-top: 5px;" onclick="addPlaylist()">Create</button>
				</div>
				<div class="playlist-list">

				</div>
			</div>

			<div class="container">
				<div class="tools">
					<div style="display: flex; align-items: center; font-size: 25px; ">
						<div id="songName" style="display: none; text-overflow: ellipsis; overflow: hidden;
						white-space: nowrap;">name</div>
						<i class="bi bi-three-dots-vertical" data-type="sel"></i>
					</div>

					<div>
						<button onclick="buttonAddSong()">Add Song</button>
						<button onclick="editSong(queue[songIndex])">Edit</button>
						<button onclick="AutoSave()">Save</button>
						<button onclick="showVideo()">Show Video</button>
						<button id="fix" onclick="fix()">fix</button>
						<button onclick="save()">Download</button>
						<button onclick="axios.get(`https:/\/lo-player.onrender.com/load`).then(res => console.log('wokage'))">wake
							server</button>
						<i class="bi bi-arrow-bar-left"></i>
					</div>

					<i class="bi bi-search-heart"></i>
					<div class="pll">
						<div id="pln"></div>
						<div id="psongs"></div>
					</div>

					<div id="sng"></div>
				</div>

				<div class="tools2">
					<div>
						<i class="bi bi-search"></i>
						<input type="text" id="search" />

						<i class="bi bi-x" style="font-size: 25px;"
							onclick="$('#search').val(''); hides.forEach(el => $('#song' + el).show())"></i>
						<i class="bi bi-arrow-bar-up bim" onclick="$(this).toggleClass('bi-arrow-bar-up bi-arrow-bar-down'); 
						$('.songElements').css('flex-direction', ($(this).hasClass('bi-arrow-bar-up') ? 'column':'column-reverse'));
						displayReverse = $('.songElements').css('flex-direction') == 'column-reverse';
						"></i>
					</div>

					<div class="playlist-tools" style="display: none;">
						<div id="playlist_title"></div>
						<button onclick="addToButton()">Add Songs</button>
					</div>
				</div>

				<div class="display">
					<!-- <div class="song-scope" id="song_scope"></div> -->
					<div class="songElements" style="display: flex;"></div>
				</div>

				<div class="accept-menu" style="display: none; padding: 5px 0;">
					<div id="selected">0 songs selected</div>
					<!-- <button onclick="addToPlaylist()">Submit</button> -->
					<i class="bi bi-three-dots" onclick="openContextMenu(event)" data-context="select"></i>
				</div>

			</div>

			<div class="right">
				<div class="queue-lable">
					Queue
					<i class="bi bi-arrow-bar-right" data-arrow-direction="open"></i>
				</div>
				<div class="queue-list-container">
					<div class="queue-list"></div>
				</div>
			</div>
		</div>

		<div class="foot">
			<div class="song-info">
				<div class="row">
					<img id="songInfoImage" class="crop" src="" alt="" />
					<i class="bi-star resize" onclick="
						$(this).toggleClass('bi-star bi-star-fill'); 
						if($(this).hasClass('bi-star-fill')) {
							songs[currentId].favorited = true;
						} else {
							songs[currentId].favorited = false;
						}
							">
					</i>
					<div class="songInfoName"></div>
				</div>
			</div>

			<div class="footmid">
				<div id="controls">
					<i class="bi-arrow-repeat togglable" onclick="repeat = !repeat"></i>
					<i class="bi-chevron-double-left" onclick="prevSong()"></i>
					<i class="bi-play" onclick="PlayPauseFlip()" play-pause-button></i>
					<i class="bi-chevron-double-right" onclick="nextSong(true, true)"></i>
					<i class="bi-shuffle" onclick="
						tog_shuffle = !tog_shuffle;
						$(this).css('opacity', tog_shuffle ? '1' : '.3');
						clickedSong(queue[songIndex]);
					"></i>
				</div>

				<div class="duration">
					<div id="elapsed">-:--</div>
					<div class="progress-container">
						<div class="progress"></div>
					</div>
					<div id="length">-:--</div>
				</div>
			</div>

			<div class="misc">
				<div class="buttons"></div>
				<div class="volume">
					<i class="bi bi-volume-up"></i>
					<div class="slidecontainer">
						<input type="range" min="0" max="100" value="0" class="slider" id="myRange" />
					</div>
				</div>
			</div>
		</div>

	</div>

	<!-- HTML MOBILE -->
	<div class="app-mobile" style="overflow: hidden;">

		<!-- <div absolutes>
		</div> -->

		<div class="nav-mobile">
			<i class="bi bi-list"></i>
			<div class="nm_info"></div>
			<i class="bi bi-search" onclick="$('#m-search').val(''); $('#m-search').toggle()"></i>

			<input type="text" id="m-search" style="display: none;" onkeydown="if(event.keyCode == 13) {
				doit(this.value)
		}" />
		</div>

		<div class="mainM" style="overflow: scroll;">

			<div class="displayM" mobile-container>

			</div>

			<div class="playlist-mc" mobile-container>
				<button onclick="$('.mobile-submit-playlist').toggle()">create</button>
				<div class="mobile-submit-playlist" style="display: none">
					<input id="mobile_create_playlist" />
					<button onclick="
						$('.mobile-submit-playlist').toggle();
						let name = $('#mobile_create_playlist').val();
						if (!name) {
							console.log('invalid')
							return;
						}
						let id = crypto.randomUUID();
						playlists[id] = {
							name: $('#mobile_create_playlist').val(),
							songs: []
						};

						$('#mobile_playlist_diplay').append(`<div class='playlist' onclick='mobilePlaylist(\`${id}\`)'>${name}</div>`)
					">submit</button>
				</div>
				<div id="mobile_playlist_diplay" style="display: flex; flex-direction: column-reverse;">

				</div>
			</div>

			<div class="add-mc" style="overflow: scroll;" mobile-container>
				<div class="tabs" style="display: flex; justify-content: space-evenly">
					<div onclick="buttonAddSong()">Manual</div>
					<div onclick="$('.add-tab').toggle()">Youtube</div>
				</div>
				<div class="add-tab" style="text-align: center; padding: 10px;">
					<input onkeydown="if (event.keyCode == 13) {
						console.log(this.value); fetch(url + '/YTsearch', {method: 'POST', 
						body: JSON.stringify({'search': this.value}), headers: {'Content-Type': 'application/json'
						}}).then(res => res.json()).then(videos => 
						$('.youtube-tab-results').html(videos.map(el => 
						`<div class='song' data-type='ytSearch' data-json='${JSON.stringify(el)}'>
						<div class='row no-click'>
							<img src='http://img.youtube.com/vi/${el.id.videoId}/0.jpg'
							class='crop'
							alt='' />
							<div>${el.title}</div>
						</div>
					</div>`)))
					}" />

					<div style="overflow: scroll;">
						<div class="youtube-tab-results"></div>
					</div>
				</div>
			</div>

			<div class="search-mc" mobile-container>
				<input type="text" id="m-search" />
			</div>

			<div class="misc-mc" mobile-container>
				<div class="ce" onclick="AutoSave()">SAVE</div>
			</div>
		</div>

		<div class="dock-bar" style="overflow: scroll;">
			<div onclick="mobilePage('library', this)" library>
				<i class="bi bi-music-note-beamed dock-icon"></i>
				<!-- <p>Library</p> -->
			</div>
			<div onclick="mobilePage('playlists', this)">
				<i class="bi bi-music-note-list dock-icon"></i>
				<!-- <p>Playlists</p> -->
			</div>
			<div onclick="mobilePage('add', this)">
				<i class="bi bi-file-plus dock-icon"></i>
				<!-- <p>Add</p> -->
			</div>
			<div onclick="mobilePage('search', this)">
				<i class="bi bi-star-fill dock-icon"></i>
				<!-- <p>Search</p> -->
			</div>
			<div onclick="mobilePage('misc', this)">
				<i class="bi bi-gear dock-icon"></i>
				<!-- <p>Misc</p> -->
			</div>
		</div>

		<div class="song-bar" style="overflow: hidden;">
			<div id="sb1">
				<img id="nm-img" class="crop" src="" alt="" />
				<div class="nm-name"></div>
				<i class="bi-play" onclick="PlayPauseFlip()" style="font-size: 40px;" play-pause-button></i>
			</div>
			<div id="sb2">

			</div>
		</div>

		<!-- <div class="mobile-player-container">
			<img id="sv-img" src="" alt="" />
		</div>

		<div class="sv-name" style="text-align: center; display: none;"></div> -->

	</div>

	<!--JS-->
	<script>
		//#region ------------------Initializers-(vars)-----------------

		var input = document.querySelector("#JData");

		var url = (window.location.origin == 'http://localhost:8080' || window.location.origin == 'http://127.0.0.1:5500') ? 'http://localhost:8080' : 'https://lo-player.onrender.com' //  window.location.origin;//

		var songs = [];
		var songScope = [];

		var selects = [];
		var selectp = [];
		var data;
		var playlists = {};

		let favorites = [];
		let songIndex = 0;
		let currentScope = '';
		let lastScope = '';
		let lastPlayed = 0;
		let hoverSongId = -1;
		let hoverSongElement;

		let player;
		let queue;
		let time = 0;
		let currentType = -1;
		let currentId = -1;
		let Etime = -1;
		let Ytime = -1;
		let time_update_save = 0;

		let info_player;
		let the_song

		let playing = false;
		let rdy = true;
		let column_sort = false;
		let seek_ready = true;
		let selecting = false;
		let ensure_start_time = true;
		let fade_bool = false;
		let end_fade = false;
		let is_typing = false;
		let boob = false;
		let fetching = false;
		let loading = false;
		let songSkipDirection = true
		let displayReverse = false;
		var repeat = false;
		var onMobile = document.querySelector('.app').style.display == 'none';

		var fetchQueue;
		var mobileScreen = 601

		var slider = document.getElementById("myRange");
		var output = document.getElementById("volumeNum");
		//var audio = document.getElementById("audio");
		let search = $("#search");
		let progress = $(".progress")[0];
		let elapsed = $("#elapsed");
		let suffleBut = $(".shuffle-button");
		let contextMenu = $("[dropdown_menu]");

		var shift = false;
		var shift2 = false;
		var last_clicked;
		var test;
		var songFile;

		var ctx = new AudioContext();
		var gain = ctx.createGain();
		gain.connect(ctx.destination);
		var source = {
			buffer: null,
			stop: (n) => { }
		};

		var jsmediatags = window.jsmediatags;
		var axios = window.axios;
		// = ctx.createBufferSource();

		var duration;
		var elapseInterval;

		var tog_shuffle = true;
		var tog_repeat = true;

		const p = (s) => console.log(s);

		var tag = document.createElement("script");

		tag.src = "https://www.youtube.com/iframe_api";
		var firstScriptTag = document.getElementsByTagName("script")[0];
		firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

		$(document).ready(async () => {
			await fetch(url + "/load")
				.then((res) => res.json())
				.then((res_data) => {
					data = res_data;
					console.log(data);

					playlists = data.playlists;
					songs = data.songs.filter(e => e.type != 'FILE');
					//songs.length = 50;

					$("#myRange").val((screen.width > mobileScreen) ? data.config.volume : 100);
					songIndex = data.config.songIndex;
					Ftime = data.config.time;
					tog_shuffle = data.config.shuffle;
					column_sort = data.config.column;

					if (column_sort) {
						$(".songElements").css("flex-direction", "column-reverse");
						$(".bi-arrow-bar-up").attr("class", "bi bi-arrow-bar-down bim");
						displayReverse = $('.songElements').css('flex-direction') == 'column-reverse';
					}

					loadPl();
					loadSongs();

					mobileSetup();
				})
				.catch((err) => {
					console.log("(865 <Initializers>) failed to get songs data: " + err);
				});
		});

		//#endregion

		//#region ------------------Loading-----------------

		async function fix() {
			// for (let i = 0; i < songs.length; i++) {
			// 	songs[i].playlists = []
			// }
			//console.log(repeat)
			player.loadPlaylist(queue.map(el => songs[el].id), songIndex, 0)
		}

		input.addEventListener("change", () => {
			// songs file selected (ALSO IS SOMEHWOW RUNNING FUCNTION ASYC???)

			let files = input.files;
			if (files.length == 0) return;
			const file = files[0];
			let reader = new FileReader();

			reader.onload = (e) => {
				const contents = e.target.result;
				data = JSON.parse(contents);

				playlists = data.playlists;
				songs = data.songs;
				//console.log("the width of the screen is " + screen.width)

				$("#myRange").val((screen.width > mobileScreen) ? data.config.volume : 100);
				songIndex = data.config.songIndex;
				Ftime = data.config.time;
				tog_shuffle = data.config.shuffle;
				column_sort = data.config.column;

				// if (column_sort) {
				// 	$("#tt").css("flex-direction", "column-reverse");
				// 	//   $("#st").css("flex-direction", "column-reverse");
				// 	//  $("#songsList").css("flex-direction", "column");
				// 	$(".bi-arrow-bar-up").attr("class", "bi bi-arrow-bar-down bim");
				// }

				loadPl();
				loadSongs();

				precleanUp();
			};
			reader.onerror = (e) => alert(e.target.error.name);
			reader.readAsText(file);
		});

		function loadPl() {
			let str = ''
			for (const [key, value] of Object.entries(playlists)) {
				str += playlistBuilder(key, value['name'])
			}
			$('.playlist-list').html(str)
			playlists['favorites'] = {
				name: 'favorites',
				songs: []
			}
		}

		function loadSongs() {
			let str = "";
			for (let i = 0; i < songs.length; i++) {
				for (let j = 0; j < songs[i]['playlists'].length; j++) {
					const element = songs[i]['playlists'][j];
					playlists[element]['songs'].push(i);
				}
				if (songs[i].favorited) playlists['favorites']['songs'].push(i);
				str += songBuilder(i, songs[i].id, songs[i].name, songs[i].type);
			}
			$('.songElements').html(str)
			queue = Array.apply(null, Array(songs.length)).map(function (x, i) {
				return i;
			});

			//console.log(playlists);

			if (tog_shuffle) {
				$(".shuffle-button").css("opacity", "1");
			}


		}

		function download(filename, text) {
			var pom = document.createElement("a");
			pom.setAttribute(
				"href",
				"data:text/plain;charset=utf-8," + encodeURIComponent(text)
			);
			pom.setAttribute("download", filename);

			if (document.createEvent) {
				var event = document.createEvent("MouseEvents");
				event.initEvent("click", true, true);
				pom.dispatchEvent(event);
			} else {
				pom.click();
			}
		}

		function save() {
			var config = {
				volume: parseInt($("#myRange").val()),
				songIndex: queue[songIndex],
				time: Ftime,
				shuffle: tog_shuffle,
				column: column_sort,
			};

			if (songs == null || config == null || data == null) return;

			var dataS = {
				config: config,
				songs: songs,
				playlists: playlists,
			};
			str = JSON.stringify(dataS);
			download("test.json", str);
		}

		AutoSave = () => {
			var config = {
				volume: parseInt($("#myRange").val()),
				songIndex: queue[songIndex],
				time: Ftime,
				shuffle: tog_shuffle,
				column: column_sort,
			};

			console.log(!songs || !config || !data);
			if (!songs || !config || !data) {
				console.log('nothing to save')
				return;
			}

			delete playlists['favorites']

			for (const [key, value] of Object.entries(playlists)) {
				playlists[key].songs = [];
			}

			var dataS = {
				config: config,
				songs: songs,
				playlists: playlists,
			};

			//fetch(url + "/save", { method: "post"})

			let xhr = new XMLHttpRequest();
			xhr.open("POST", url + "/save", true);
			xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

			xhr.onreadystatechange = function () {
				if (xhr.readyState === 4 && xhr.status === 200) console.log(this.responseText);
			};

			xhr.send(JSON.stringify(dataS));
		};

		function songBuilder(id_num, im_link_id, name, type) {
			switch (type) {
				case 'FILE':
					return `<div class="song" id="song${id_num}" data-song-id="${id_num}" data-type="all">
					<div class="row no-click">
						<img src="${im_link_id}"
								class="crop"
								alt="" />
								<div class="song-text">${eval(id_num + 1)}: ${name}</div>
							</div>
							<dd>
								 <i class="bi bi-three-dots"></i>
							</dd>
					</div>`;

				case 'YOUTUBE':
					return `
					<div class="song" id="song${id_num}" data-type="song" data-song-id="${id_num}" data-context="song">
						<div class="song-num">${eval(id_num + 1)}:</div>
						<img src="http://img.youtube.com/vi/${im_link_id}/0.jpg"
							class="crop song-img"
							alt=""
						/>
						<div class="song-name">${name}</div>	
						<i class="bi bi-three-dots song-dots" style="font-size: 28px"></i>
					</div>`;
			}
		}

		function playlistBuilder(key, value) {
			return `<div class="playlist" onclick="openPlaylist('${key}'); $('.playlist-tools').show()">${value}</div>`
		}

		function mobileSetup() {
			setupSwap()
			let content;
			for (const [key, value] of Object.entries(playlists)) {
				content += `<div class="playlist" onclick="mobilePlaylist('${key}')">${value['name']}</div>`
			}
			//$('.nm_info').html('Playlists')
			$('#mobile_playlist_diplay').html(content)
		}
		//#endregion

		//#region ------------------Functions-----------------

		//#region Song players and HUD
		async function playSong() {
			if (songs[queue[songIndex]].type == "YOUTUBE")
				seek_ready = false;

			progress.style.width = "0%";
			elapsed.html("0:00");

			$(".playing").removeClass("playing");
			$(`[data-song-id="${queue[songIndex]}"]`).addClass("playing");

			the_song = songs[queue[songIndex]];
			ChangeType(currentType, the_song.type);
			currentType = the_song.type;
			currentId = queue[songIndex];

			Etime = 1;

			if (screen.width < mobileScreen) {
				setVolume(100)
			}

			switch (currentType) {

				case 'YOUTUBE':

					// if (screen.width < mobileScreen) {
					// 	player.loadPlaylist([the_song.id, 'cdwal5Kw3Fc'])
					// 	updateHUDInfo(the_song);
					// 	break;
					// }

					//	console.log(the_song.start)
					loading = true

					player.setVolume(0)

					do {
						await delay(100)
					} while (player.getVolume())

					//await delay(100)

					//while()


					player.loadVideoById({
						videoId: the_song.id,
					});

					//player.loadPlaylist([  songs[queue[((songIndex-1) < 0) ? queue.length-1:songIndex-1]].id, the_song.id, songs[queue[((songIndex+1) > queue.length-1) ? 0:songIndex+1]].id], 1, 0)


					//	player.seekTo(the_song.start)

					setVolume(slider.value)
					updateHUDInfo(the_song);
					break;

				case 'FILE':
					if (source.buffer != null) source.buffer = null;

					var path = the_song.link
						.replace(/\\/g, "☹☸☼☺☿☾☻")
						.replace(/\//g, "☹☸☼☺☿☾☻");

					if (fetching) {
						fetchQueue = path;
						return;
					}
					fetching = true;
					await fetch(url + "/song/" + path)
						.then((res) => {
							//console.log(res)
							return res.arrayBuffer();
						})
						.then((ab) => {
							return ctx.decodeAudioData(ab);
						})
						.then((decodedAudio) => {
							songFile = decodedAudio;
						})
						.then(() => {
							source.stop(0);
							fetching = false;
							if (fetchQueue != null) {
								fetchQueue = null;
								playSong();

								return;
							}
							source = ctx.createBufferSource();
							source.buffer = songFile;
							source.connect(gain);
							source.start(0, Ftime);

							duration = source.buffer.duration;
							if (elapseInterval == null)
								elapseInterval = setInterval(UpdateElapsed, 1000);
							updateHUDInfo(the_song);
						})
						.catch((err) => {
							console.log(err);
							fetching = false;
							nextSong();
						});

					break;

			}

			duration = the_song.end - the_song.start;//event.target.getDuration();
			$("#length").html(secsToTime(duration));

			//await delay(50);
			//setVolume(slider.value);
		}

		function clickedSong(i) {
			if (!Number.isInteger(i)) {
				console.log("clicked song id is not a number!");
				return;
			}

			if (shift) {
				if (i == queue[songIndex] || i == queue[songIndex + 1]) return;
				var ind = queue.indexOf(i);
				if (ind < songIndex) songIndex--;
				queue.splice(ind, 1);
				queue.splice(songIndex + 1, 0, i);

				updateQueueHUD();
				return;
			}

			let toSplice = 0;

			//	if (currentScope !== lastScope) {
			if (currentScope) {
				queue = [...playlists[currentScope]['songs']]
				toSplice = queue.indexOf(i)
			} else {
				queue = [...Array.apply(null, Array(songs.length)).map(function (x, j) {
					return j;
				})];
				toSplice = i;
			}
			//}

			lastScope = currentScope;

			if (tog_shuffle) {
				queue.splice(toSplice, 1)
				queue = [...shuffleArray([...queue])];
				queue.unshift(i)

				songIndex = 0;
			} else
				songIndex = queue.indexOf(i);

			//console.log(queue)

			if (i != currentId)
				return playSong();

		}

		function updateHUDInfo(thesong) {
			$(`#song${queue[songIndex]}`).addClass("playing");

			$("#songInfoImage").attr(
				"src",
				`http://img.youtube.com/vi/${thesong.id}/0.jpg`
			);

			$(".songInfoName").html(
				thesong.name.length > 25 ?
					`${thesong.name.substring(0, 25)}...` :
					thesong.name
			);
			$("#songName").html(thesong.name);

			$("#nm-img").attr(
				"src",
				`http://img.youtube.com/vi/${thesong.id}/0.jpg`
			);
			$('.nm-name').html(thesong.name)

			$('#sv-img').attr('src', $('#nm-img').attr('src'))
			$('.sv-name').html(thesong.name)

			document.title = thesong.name;
			let temp = $(".resize");
			if (thesong.favorited) {
				$(temp).attr("class", "bi-star-fill resize");
			} else {
				$(temp).attr("class", "bi-star resize");
			}

			$("#length").html(function () {
				return `${Math.floor(
					duration / 60
				)}:${Math.floor(duration % 60) < 10 ? `0${Math.floor(duration % 60)}` : Math.floor(duration % 60)}`;
			});

			seek_ready = true;

			// LoadDuration();
			//	$(`[data-song-id="${queue[songIndex]}"`)[0].scrollIntoView();
		}

		function updateQueueHUD() {
			//$(".queue-list").html(queue.map(el => $(`#song${el}`).clone()))
			var div = $(".queue-list");
			div.html("");
			var str = "";

			for (j = 0; j < queue.length; j++) {
				var el = $(`#song${queue[j]}`).clone().attr("data-type", "inqueue");
				el.find("dd").remove();
				str += el.prop("outerHTML");
			}
			div.html(str);
		}

		//#endregion

		//#region UI (Button Logic)
		function openPlaylist(s) {
			//do that loop through vis if in target remove from target if not hide; first tuen playlist into dictionary
			currentScope = s;

			if (!s)
				return showAllSongs()

			let target = {};
			playlists[s]['songs'].forEach(el => target[el] = el);
			$('.songElements>*:visible').each((i, el) => target[el.dataset.songId] ?
				delete target[el.dataset.songId] : $(el).hide())

			for (const [key, vaule] of Object.entries(target))
				$(`.songElements :nth-child(${+key.toString() + 1})`).show()

		}

		function buttonAddSong() {
			$(".add-song-form").show();

			$('#form_buttons').html(`<button class="form-option" style="width: 50%" onclick="submitNewSong()">
						Add Song
					</button>
					<button class="form-option" style="width: 50%" onclick="closeSongForm()">
						Cancel
					</button>`)

			$("#name").val('')
			$("#link").val('')
			$('#type').val('YOUTUBE')
			$("#startTime").val('0')
			$("#endTime").val('')
			$(".form-blur").show();
		}

		async function submitNewSong() {
			closeSongForm();

			let n = $("#name").val();
			let l = linkParser($("#link").val());
			let t = $("#type").val();
			let start = $("#startTime").val();
			let end = $("#endTime").val();

			start = start.includes(':') ? hmsToSecs(start) : +start
			end = end.includes(':') ? hmsToSecs(end) : +end

			if (!l) {
				console.log("invaalid");
				closeSongForm();
				return;
			}

			info_player.loadVideoByUrl(l)

			if (!n || !end) {
				let time = 0;
				let now = Date.now()
				while (info_player.getPlayerState() != 2) {
					console.log(time)
					time = Date.now() - now;
					if (time > 4000) {
						console.log('failed to get song')
						return;
					}
					await delay(250)
				}

			}

			if (!n)
				n = info_player.videoTitle;

			if (!start)
				start = 0;

			if (!end)
				end = info_player['playerInfo']['duration'];

			let links = l.split("|");
			console.log(links);

			let sng = {
				name: n,
				link: l,
				id: '',
				playlists: [],
				favorited: false,
				type: t,
				start: start,
				end: end,
				end_raw: secsToTime(end - start)
			};

			if (t == 'FILE') {
				sng.id = crypto.randomUUID();
			}

			if (t == 'YOUTUBE') {
				sng.id = idParser(linkParser(l));
			}

			console.log(sng)

			songs.push(sng);
			queue.push(songs.length - 1);
			$("#form").html("");
			$("#song_scope").append(
				songBuilder(songs.length - 1, songs[songs.length - 1].id, n, t)
			);

			closeSongForm();
		}

		function YT_SEARCH(s) {
			axios.post(url + '/YTsearch', { search: s }).then(res => {
				console.log(res.data);
				vids = res.data.videos;
				let str = "";
				vids.forEach((el, i) => str += `<div class="song" data-type="ytSearch" data-json='${JSON.stringify(el)}' onclick='ytAdd(event)'>
							<div class="row no-click">
								<img src="http://img.youtube.com/vi/${el.id}/0.jpg"
								class="crop"
								alt="" />
								<div>${el.title}</div>
							</div>
						</div>`);
				$('.yt-vids').html(str);
			})
		}

		function ytMenu() {
			$('.yt-abs').css({
				'top': `${$('[tysbut]').offset().top + 20}px`,
				'left': `${$('[tysbut]').offset().left - 30}px`
			})
			$('.yt-abs').toggle()
		}

		function ytAdd(e) {
			$(e.target).addClass("selected");
			let song_data = JSON.parse(e.target.dataset.json);
			console.log(song_data);

			let sng = {
				name: song_data['title'],
				link: song_data['link'],
				id: song_data['id'],
				playlists: [],
				favorited: false,
				type: 'YOUTUBE',
				start: 0,
				end: hmsToSecs(song_data['duration_raw']),
				end_raw: song_data['duration_raw'],
			};
			songs.push(sng);
			queue.push(songs.length - 1);
			let str = songBuilder(songs.length - 1, sng.id, sng.name, 'YOUTUBE')
			$(".songElements").append(str);

			if (!currentScope)
				$(".song-scope").append(str);
		}

		async function SpotifySearch(s) {
			await axios.post(url + '/SpotifyPlaylist', { search: s }).then(res => {
				res.data.forEach(async el => {
					await axios.post(url + '/YTsearch', { search: el.name + ' ' + el.artist }).then(vids => {
						let song_data = vids.data.filter(ee => nearEnough(+hmsToSecs(ee['duration_raw']), +hmsToSecs(el['length']), 3))[0]
						if (!song_data)
							song_data = vids.data[0]
						console.log(song_data)
						let sng = {
							name: song_data['title'],
							link: song_data['url'],
							id: song_data['id']['videoId'],
							playlists: [],
							favorited: false,
							type: 'YOUTUBE',
							start: 0,
							end: hmsToSecs(song_data['duration_raw']),
							end_raw: song_data['duration_raw'],
						};
						songs.push(sng);
						queue.push(songs.length - 1);
						$(".display").append(
							songBuilder(songs.length - 1, songs[songs.length - 1].id, sng.name, 'YOUTUBE')
						);
					})

				});
			})
		}

		async function yt_auto_fill() {
			console.log(linkParser($('#link').val()))
			info_player.loadVideoByUrl(linkParser($('#link').val()))
			let time = 0;
			let now = Date.now()
			while (info_player.getPlayerState() != 2) {
				console.log(time)
				time = Date.now() - now;
				if (time > 4000) {
					console.log('failed to get song')
					return;
				}
				await delay(250)
			}

			$('#name').val(info_player.videoTitle)
			$('#type').val('YOUTUBE')
			$('#endTime').val(secsToTime((info_player['playerInfo']['duration'])))
		}

		function addPlaylist() {
			$('.playlist-form').hide()
			let name = $('#playlist_name').val()
			if (!name) {
				console.log('invalid')
				return;
			}
			let id = crypto.randomUUID()
			playlists[id] = {
				name: $('#playlist_name').val(),
				songs: []
			}
			$('.playlist-list').append(playlistBuilder(id, name))
			$('#playlist_name').val('')
			openPlaylist(id)
		}

		function setVolume(v) {
			switch (currentType) {
				case 'FILE':
					gain.gain.setValueAtTime(v / 100, ctx.currentTime);
					//audio.volume = (v / 100) * 0.45;
					break;

				case 'YOUTUBE':
					if (screen.width < mobileScreen) {

						slider.value = 100
						player.setVolume(100);
					} else
						player.setVolume(v);

					break;
			}
			volume = v;
		}

		function editSong(id) {
			$(".add-song-form").show();
			let buts = `	
			<button class="form-option" onclick="submitEditedSong(${id})">Edit Song</button>
				<button class="form-option" onclick="closeSongForm()">Cancel</button>
				`

			$('#form_buttons').html(buts)
			$(".form-blur").show();

			$("#name").val(songs[id].name)
			$("#link").val(songs[id].link)
			$('#type').val(songs[id].type)
			$("#startTime").val(secsToTime(songs[id].start))
			$("#endTime").val(secsToTime(songs[id].end))
		}

		function submitEditedSong(id) {

			if (!$("#name").val()) {
				console.log('invalid');
				return;
			}

			songs[id].name = $("#name").val();
			songs[id].link = linkParser($("#link").val());
			songs[id].type = $('#type').val()
			songs[id].start = $("#startTime").val().includes(':') ? hmsToSecs($("#startTime").val()) : +$("#startTime").val();
			songs[id].end = $('#endTime').val().includes(':') ? hmsToSecs($("#endTime").val()) : +$("#endTime").val();
			songs[id].end_raw = secsToTime(songs[id].end - songs[id].start)
			songs[id].id = idParser(linkParser($("#link").val()));


			for (const [key, value] of Object.entries($(`[data-song-id="${id}"]`))) {
				//console.log(key)
				//console.log(value)
				value.outerHTML = songBuilder(
					id,
					songs[id].id,
					songs[id].name,
					songs[id].type
				);
			}

			updateHUDInfo(songs[id]);

			closeSongForm();
		}

		function addToButton() {
			selecting = true;
			showAllSongs();
			$('.accept-menu').show()
		}

		function addToPlaylist(playlist, songId) {
			let list = playlists[playlist]['songs']
			if (list.findIndex(el => el === songId) == -1)
				list.push(songId);
			songs[songId]['playlists'].push(playlist)
		}

		function openMiscForm(str) {

			let content = '';

			switch (str) {
				case 'addToPlaylist':
					for (const [key, value] of Object.entries(playlists)) {
						console.log(key)
						if (key == 'favorites')
							continue
						content += `<div class="playlist" onclick="selectPlaylist(event, '${key}')">${value['name']}</div>`
					}

					console.log(content)

					content += `<button onclick="selAddToPlaylist()">Add</button>`
					break;

				default: console.log('??????not a form??????')
			}

			$('.misc-form').html(content)
			$('.form-blur').show()
			$('.misc-form').show()
		}

		function selAddToPlaylist() {
			if (!selects.length)
				selects.push(hoverSongId)
			console.log(selects)
			selects.forEach(el => {
				selectp.forEach(el2 => {
					addToPlaylist(el2, el)
				})
			})
			selects = []
			selectp = []
			updateScope()
		}

		function selectPlaylist(e, key) {
			e.stopPropagation()
			$(e.target).toggleClass('selected');
			$(e.target).attr('class').includes('selected') ?
				selectp.push(key) :
				selectp.splice(selects.findIndex(el => el == key), 1)
			//console.log(key)
		}

		function selectSong(id) {
			//e.stopPropagation()
			console.log(id)
			selecting = true
			$('.accept-menu').show()
			$(`[data-song-id="${id}"]`).toggleClass('selected');
			$(`[data-song-id="${id}"]`).attr('class').includes('selected') ?
				selects.push(id) :
				selects.splice(selects.findIndex(el => el == id), 1)
			console.log(selects)
			$('#selected').html(selects.length + ' Selected')
			if (!selects.length) {
				selecting = false;
				$('.selected').removeClass('selected')
				$('.accept-menu').hide()
			}
		}

		//#endregion

		//#region misc

		function openContextMenu(e, ele, ctx = ele.dataset.context) {
			if (screen.width < mobileScreen) {
				openMobileContextMenu(e)
				return;
			}

			let content = '';
			let el = ele.dataset;

			switch (ctx) {

				case 'song':
					let song = songs[el.songId];
					content =
						`
				 <div style="display: flex;">
				  <img class='crop' src="http://img.youtube.com/vi/${song.id}/0.jpg" />
					<p style="margin-left: 5px; text-overflow: ellipsis; overflow: hidden;
						white-space: nowrap;">${song.name}</p> 
					</div>
					<hr/>
					<div class="dd-options">
						<div onclick="clickedSong(${el.songId})">Play</div>
						<div onclick="shift = true;	clickedSong(${el.songId}); shift = false;">Play Next</div>
						<div onclick="queue.push(${el.songId}); updateQueueHUD()">Queue</div>
						<hr/>
						<div onclick="songs[${el.songId}].favorited = !songs[${el.songId}].favorited">${(song.favorited) ? 'Unfavorite' : 'Favorite'}</div>
						${(currentScope) ? `<div onclick="let arr = playlists[currentScope]['songs']; arr.splice(arr.findIndex(el => el==${el.songId}) ,1); updateScope()">Remove from Playlist</div>` : ""}
						<div data-hover-menu="addPlaylist" onclick="event.stopPropagation(); $('#hover-menu').show()" style="display: flex; justify-content: space-between; align-items: center;">
							<div>${(currentScope) ? 'Add to Another Playlist' : 'Add to Playlist'}</div>
							<i class="bi bi-caret-right-fill"></i>
						</div>
						
						<hr/>
						<div onclick="editSong(${el.songId})">Edit</div>
						<div onclick="selectSong(${el.songId}); $('.dropdown-menu').hide(); event.stopPropagation()">Select</div>
						<div style="color: red" onclick="">Delete</div>
					</div>
					`
					break;

				case 'select':
					content =
						`
					<p style="margin-left: 5px; text-overflow: ellipsis; overflow: hidden;
						white-space: nowrap;">${selects.length} select(s)</p> 
					<hr/>
					<div class="dd-options">
						<div onclick="clickedSong(${'el.songId'})">Play</div>
						<div onclick="shift = true;	clickedSong(${'el.songId'});	shift = false;">Play Next</div>
						<div onclick="queue.push(${'el.songId'}); updateQueueHUD()">Queue</div>
						<hr/>
						<div onclick="songs[${'el.songId'}].favorited = !songs[${'el.songId'}].favorited">${('song.favorited') ? 'Unfavorite' : 'Favorite'}</div>
						${(currentScope) ? `<div onclick="let arr = playlists[currentScope]['songs']; arr.splice(arr.findIndex(el => el==${'el.songId'}) ,1); updateScope()">Remove from Playlist</div>` : ""}
						<div data-hover-menu="addPlaylist" onclick="event.stopPropagation(); $('#hover-menu').show()" style="display: flex; justify-content: space-between; align-items: center;">
							<div>${(currentScope) ? 'Add to Another Playlist' : 'Add to Playlist'}</div>
							<i class="bi bi-caret-right-fill"></i>
						</div>
						
						<hr/>
						<div onclick="editSong(${'el.songId'})">Edit</div>
						<div onclick="selectSong(${'el.songId'}); $('.dropdown-menu').hide(); event.stopPropagation()">Select</div>
						<div style="color: red" onclick="">Delete</div>
					</div>
					`
					break;

				default:
					console.log(e.target)
			}

			contextMenu.html(content);
			contextMenu.show();

			contextMenu.addClass("active");

			//if (screen.width < mobileScreen) {
			//	return
			//}

			let yHalf = window.innerHeight / 2;
			let xHalf = window.innerWidth / 2;

			//console.log(xHalf)

			contextMenu.css("top", `${e.pageY - (e.clientY > yHalf ? 300 : 10)}px`);
			contextMenu.css("left", `${e.pageX - (e.clientX > xHalf ? 150 : 10)}px`);

			// if (e.clientY > middlehalf) {
			// 	contextMenu.css("top", `${e.pageY - 300}px`);
			// 	contextMenu.css("left", `${e.pageX - 10}px`);
			// } else {
			// 	contextMenu.css("top", `${e.pageY - 10}px`);
			// 	contextMenu.css("left", `${e.pageX - 10}px`);
			// }

			//	$('.dropdown-menu').hide()

		}

		ChangeType = (i, j) => {
			if (i == j) return;
			//remove
			switch (i) {
				case 'FILE':
					source.stop();
					ctx.suspend();
					//clearInterval(elapseInterval)
					break;

				case 'YOUTUBE':
					player.pauseVideo();
					// $("#sng").hide();
					break;
			}

			//boot engine
			switch (j) {
				case 'FILE':
					ctx.resume();
					//elapseInterval = setInterval(UpdateElapsed, 1000)
					break;

				case 'YOUTUBE':
					//$("#sng").show();
					break;
			}
		};

		function linkParser(s) {
			//https://www.youtube.com/watch?v=fgZ-Pyk7G6A&ab_channel=MoriCalliope-Topic
			//https://youtu.be/fgZ-Pyk7G6A
			//https://www.youtube.com/embed/fgZ-Pyk7G6A

			let id = idParser(s);

			return "https://www.youtube.com/embed/" + id + "?autoplay=1";
		}

		function idParser(url) {
			const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
			const match = url.match(regExp);
			return (match && match[7].length == 11) ? match[7] : false;
		}

		function shuffle(ink) {
			//queue.length = 100
			//queue.sort(() => Math.random() - 0.5);
			// queue = shuffleArray(queue);
			// queue.unshift(ink)

			let temp = queue.indexOf(ink);
			let temp2 = queue[0];
			queue[0] = ink;
			queue[temp] = temp2;
			songIndex = 0;

			//	updateQueueHUD();
		}

		function shuffleArray(array) {
			for (let i = array.length - 1; i > 0; i--) {
				let j = Math.floor(Math.random() * (i + 1));
				[array[i], array[j]] = [array[j], array[i]];
			}
			return array;
		}

		function togQueue() {
			$(".queue-list-container").hide();
		}

		function reverseQueue() {
			let temp = queue[songIndex];
			queue.reverse();
			songIndex = queue.indexOf(temp);
		}

		function clamp(num, min, max) {
			return num <= min ? min : num >= max ? max : num;
		}

		function setProgress(e) {
			const width = e.target.clientWidth;
			const clickX = e.offsetX;

			progress.style.width = `${clamp((clickX / width) * 100, 0, 100)}%`;

			t = clamp((clickX / width) * duration, 0, duration);

			$("#elapsed").html(() => {
				let temp = Math.floor(t % 60);
				return `${Math.floor(t / 60)}:${temp < 10 ? `0${temp}` : temp}`;
			});
		}

		function seekTo(e) {
			const width = e.target.clientWidth;
			const clickX = e.offsetX;
			//var duration;

			switch (currentType) {
				case 'FILE':
					source.stop();
					source = ctx.createBufferSource();
					source.buffer = songFile;
					source.connect(gain);
					source.start(0, clamp((clickX / width) * duration, 0, duration));
					break;

				case 'YOUTUBE':
					player.seekTo(
						clamp(((clickX / width) * duration) + the_song.start, the_song.start, the_song.end),
						true
					);
					break;
			}
			Etime = Math.floor(clamp((clickX / width) * duration, 0, duration));
		}

		function closeSongForm() {
			$(".add-song-form").hide()
			$(".form-blur").hide()
			$('.misc-form').hide()
			$('#dropdown_menu').hide()
		}

		function showAllSongs() {
			$('.songElements>*:hidden').show()
		}

		function flipSort() {
			column_sort = !column_sort;
			if (column_sort) {
				$("#tt").css("flex-direction", "column-reverse");
				// $("#st").css("flex-direction", "column-reverse");
				// $("#songsList").css("flex-direction", "column");
				$(".bi-arrow-bar-up").attr("class", "bi bi-arrow-bar-down bim");
			} else {
				$("#tt").css("flex-direction", "column");
				//$("#st").css("flex-direction", "column");
				//$("#songsList").css("flex-direction", "column-reverse");
				$(".bi-arrow-bar-down").attr("class", "bi bi-arrow-bar-up bim");
			}
		}

		async function delay(secs) {
			return new Promise((resolve) => {
				setTimeout(() => resolve(""), secs);
			});
		}

		async function timeUpdate() {

			while (playing) {
				Etime = Math.floor(player.playerInfo.currentTime - the_song.start)
				//	console.log(Etime)
				updateElapsed()
				await delay(950)
			}

			// while (playing) {
			// 	for (let time_partition = time_update_save; time_partition < 10 && playing; time_partition++) {
			// 		time_update_save = time_partition;
			// 		await delay(90);
			// 	}
			// 	if (time_update_save > 8) {
			// 		time_update_save = 0;
			// 		//Etime++;
			// 		Etime = parseInt(player.playerInfo.currentTime)
			// 		updateElapsed()
			// 	}
			// }
		}

		function updateElapsed() {
			if (!seek_ready) return;

			if (Etime > duration - 1) {
				Etime = 1;
				progress.style.width = "0%";
				elapsed.html("0:00");
				nextSong(true);
				return;
			}

			$("#elapsed").html(() => {
				let temp = Etime % 60;
				return `${Math.floor(Etime / 60)}:${temp < 10 ? `0${temp}` : temp}`;
			});
			progress.style.width = `${(Etime / duration) * 100}%`;
		}

		function updateProgress(e) {
			const {
				duration,
				currentTime
			} = e.target;
			var progressPercent = (currentTime / duration) * 100;
			progress.style.width = `${progressPercent}%`;
		};

		function secsToTime(secs) {
			if (!secs && secs !== 0)
				return '-:--';
			return new Date(secs * 1000).toISOString().substring(14, 19).replace(/^0+/, '').substring().replace(/^:+/, '0:');
		}

		function hmsToSecs(str) {
			var p = str.split(':'),
				s = 0, m = 1;

			while (p.length > 0) {
				s += m * parseInt(p.pop(), 10);
				m *= 60;
			}

			return s;
		}

		function nearEnough(target, compare, range) {

			return Math.abs(target - compare) < range;
		}

		async function fadeAudio(start, end, iterations, add, delays) {

			if (start == end) {
				if (isPlaying()) pauseSong();
				else ResumeSong();
				return;
			}

			var increasing = start < end;
			setVolume(start);
			for (let i = 0; i < iterations; i++) {
				await delay(delays);
				start = eval(start + add);
				if (increasing && start >= end) {
					setVolume(slider.value);
					return;
				}
				if (!increasing && start <= end) {
					setVolume(end);
					pauseSong();
					return;
				}
				setVolume(start);
			}
			if (!increasing) {
				pauseSong();
				setVolume(end);
			}
		}
		//#endregion


		//#endregion

		//#region ---------------------MOBILE-------------------------

		function mobilePage(s, el) {
			$('[mobile-container]').hide();
			$('.dock-bar>div.active').removeClass('active');
			$(el).toggleClass('active')
			let content = ''
			switch (s) {
				case 'library':
					$('.displayM').show()
					showAllSongs()
					$('.nm_info').html('Library')
					break;

				case 'playlists':

					//for (const [key, value] of Object.entries(playlists)) {
					//	content += `<div class="playlist" onclick="mobilePlaylist('${key}')">${value['name']}</div>`
					//}
					$('.nm_info').html('Playlists')
					//	$('#mobile_playlist_diplay').html(content)
					$('.playlist-mc').show()
					break;

				case 'add':
					//buttonAddSong()
					$('.add-mc').show()
					break;

				case 'search':
					$('.search-mc').show()
					break;

				case 'misc':
					$('.misc-mc').show()
					break;


				default:
					console.log('huh')
			}
		}

		function mobilePlaylist(s) {
			$('.playlist-mc').hide()
			$('.displayM').show()
			openPlaylist(s)
			$('#nm_info').html(playlists[s]['name'])
		}

		function setupSwap() {
			if (onMobile && $('.app').is(':visible')) { //to main
				p('to app')
				$('.songElements').detach().appendTo('.display')
				$('#controls').after($('.duration').detach())
				onMobile = false;
			}
			else if (!onMobile && $('.app-mobile').is(':visible')) { // to mobile
				p('to mobile')
				$('.songElements').detach().appendTo('.displayM')
				$('#sb1').show();
				$('#sb2').hide();
				$('#sb2').append($('.duration').detach())
				mobilePage('library', $('[library]')[0])
				onMobile = true;
			}
		}

		// function songBarClick() {
		// 	$('.nav-mobile').hide()
		// 	$('.main-container').hide()
		// 	$('.dock-bar').hide()
		// 	$('#sb1').hide()
		// 	$('.mobile-player-container').show()
		// 	$('#sb2').show()
		// 	$('.foot').show()
		// 	$('.sv-name').show()
		// }

		// function songBarClose() {
		// 	$('.nav-mobile').show()
		// 	$('.main-container').show()
		// 	$('.dock-bar').show()
		// 	$('#sb1').show()
		// 	$('#sb2').hide()
		// 	$('.mobile-player-container').hide()
		// 	$('.sv-name').hide()
		// 	$('.foot').hide()
		// }

		function openMobileContextMenu(e) {
			let content = '';
			let el = e.target.dataset;


			switch (el.context) {
				case 'song':
					let song = songs[el.songId];
					content =
						`
				 <div style="display: flex;">
				  <img class='crop' src="http://img.youtube.com/vi/${song.id}/0.jpg" />
					<p style="margin-left: 5px; text-overflow: ellipsis; overflow: hidden;
						white-space: nowrap;">${song.name}</p> 
					</div>
					<hr/>
					<div class="dd-options">
						<div onclick="clickedSong(${el.songId})">Play</div>
						<div onclick="shift = true;	clickedSong(${el.songId});	shift = false;">Play Next</div>
						<div onclick="queue.push(${el.songId}); updateQueueHUD()">Queue</div>
						<hr/>
						<div onclick="songs[${el.songId}].favorited = !songs[${el.songId}].favorited">${(song.favorited) ? 'Unfavorite' : 'Favorite'}</div>
						${(currentScope) ? `<div onclick="let arr = playlists[currentScope]['songs']; arr.splice(arr.findIndex(el => el==${el.songId}) ,1); updateScope()">Remove from Playlist</div>` : ""}
						<div  onclick="event.stopPropagation(); contextMenuMobileButtonLogic('addToPlaylist')" style="display: flex; justify-content: space-between; align-items: center;">
							<div>${(currentScope) ? 'Add to Another Playlist' : 'Add to Playlist'}</div>
							<i class="bi bi-caret-right-fill"></i>
						</div>
						
						<hr/>
						<div onclick="editSong(${el.songId})">Edit</div>
						<div onclick="selectSong(${el.songId}); $('.dropdown-menu').hide(); closeSongForm(); event.stopPropagation()">Select</div>
						<div style="color: red" onclick="">Delete</div>
					</div>
					`
					break;

				case 'select':
					content =
						`
					<p style="margin-left: 5px; text-overflow: ellipsis; overflow: hidden;
						white-space: nowrap;">${selects.length} select(s)</p> 
					<hr/>
					<div class="dd-options">

						<div onclick="clickedSong(${'el.songId'})">Play</div>

						<div onclick="shift = true;	clickedSong(${'el.songId'});	shift = false;">Play Next</div>

						<div onclick="queue.push(${'el.songId'}); updateQueueHUD()">Queue</div>

						<hr/>

						<div onclick="songs[${'el.songId'}].favorited = !songs[${'el.songId'}].favorited">${('song.favorited') ? 'Unfavorite' : 'Favorite'}</div>

						${(currentScope) ? `<div onclick="let arr = playlists[currentScope]['songs']; arr.splice(arr.findIndex(el => el==${'el.songId'}) ,1); updateScope()">Remove from Playlist</div>` : ""}

						<div onclick="event.stopPropagation(); contextMenuMobileButtonLogic('addToPlaylist')" style="display: flex; justify-content: space-between; align-items: center;">
							<div>${(currentScope) ? 'Add to Another Playlist' : 'Add to Playlist'}</div>
							<i class="bi bi-caret-right-fill"></i>
						</div>
						
						<hr/>
						<div onclick="editSong(${'el.songId'})">Edit</div>
						<div onclick="selectSong(${'el.songId'}); $('.dropdown-menu').hide(); event.stopPropagation()">Select</div>
						<div style="color: red" onclick="">Delete</div>
					</div>
					`
					break;

				default:
					console.log('gi me name is doc tor falcjhii')
					return;
			}

			$(".form-blur").show()
			$('.misc-form').html(content)
			$('.misc-form').show()
		}

		function contextMenuMobileButtonLogic(s) {
			let content = '';

			switch (s) {
				case 'addToPlaylist':
					for (const [key, value] of Object.entries(playlists)) {
						if (key == 'favorites')
							continue
						content += `<div class="playlist" onclick="selectPlaylist(event, '${key}')" data-key="${key}" >${value['name']}</div>`
					}
					content += `<div style="display: flex; justify-content: space-between">
						<button onclick="selAddToPlaylist(); closeSongForm()">Add</button>
					</div> `
					$('.misc-form').html(content)
					break;

				case 'select':
					closeSongForm()
					break;

				default:
					break;
			}

		}

		//#endregion

		//#region ---------------------API-------------------------

		function onYouTubeIframeAPIReady() {
			player = new YT.Player("sng", {
				playerVars: { 'autoplay': 1, 'controls': 1 },
				events: {
					onStateChange: onPlayerStateChange,
					onError: err,
				},
			});

			info_player = new YT.Player("info_player", {
				width: 200,
				height: 200,
				playerVars: { 'autoplay': 0, 'controls': 1 },
				events: {
					onReady: onPlayerReady,
					onStateChange: e => { if (e.data == 1) info_player.pauseVideo(); }
				},
			});

			//let iframeWindow = player.getIframe().contentWindow;
			//
			//let lastTimeUpdate = 0;

			// window.addEventListener("message", function (event) {
			//   if (event.source === iframeWindow) {
			//     let data = JSON.parse(event.data);

			//     if (
			//       data.event === "infoDelivery" &&
			//       data.info &&
			//       data.info.currentTime
			//     ) {
			//       Ytime = Math.floor(data.info.currentTime);

			//       if (Ytime !== lastTimeUpdate && seek_ready) {
			//         $("#elapsed").html(() => {
			//           let temp = Ytime % 60;
			//           return `${Math.floor(Ytime / 60)}:${
			//             temp < 10 ? `0${temp}` : temp
			//           }`;
			//         });
			//         progress.style.width = `${(Ytime / duration) * 100}%`;
			//       }
			//     }
			//   }
			// });
		}

		function onPlayerReady(event) {
			info_player.loadVideoById(`wjOj_6cMGEY`)
			info_player.setVolume(0)
			info_player.mute()
		}

		function onPlayerStateChange(event) {
			if (currentType != 'YOUTUBE') return;
			switch (event.data) {
				case YT.PlayerState.PLAYING: {
					if (loading) {
						pauseSong()
						return;
					}
					$("[play-pause-button]").attr("class", "bi-pause");
					break;
				}
				case YT.PlayerState.ENDED: {
					progress.style.width = "0%";
					elapsed.html("0:00");
					nextSong(true);
					break;
				}
				case YT.PlayerState.PAUSED: {
					if (loading) {
						player.seekTo(songs[queue[songIndex]].start)
						loading = false;
						ResumeSong()
						return;
					}
					$("[play-pause-button]").attr("class", "bi-play");
					clearInterval(elapseInterval);
					elapseInterval = null;
					break;
				}
				case YT.PlayerState.BUFFERING: {
					//$("[play-pause-button]").attr("class", "arc");
					clearInterval(elapseInterval);
					elapseInterval = null;
					break;
				}
				case YT.PlayerState.CUED: {
					break;
				}
			}
			playing = event.data == YT.PlayerState.PLAYING
			timeUpdate()
		}

		function stopVideo() {
			player.stopVideo();
		}

		function err(er) {
			if (!data) return;
			if (currentType != 'YOUTUBE') return;

			nextSong();
		}

		function nextSong(bool = songSkipDirection, force) {

			if (!force) {
				if (!bool)
					return prevSong();

				if (repeat && bool != false) {
					player.seekTo(0.1)
					return
				}
			}

			$(`[data-song-id="${queue[songIndex]}"]`).removeClass("playing");

			if (!displayReverse)
				songIndex = songIndex > queue.length - 2 ? 0 : songIndex + 1;
			else
				songIndex = songIndex ? songIndex - 1 : queue.length - 1;

			playSong();
			songSkipDirection = true;
		}

		function prevSong() {

			$(`[data-song-id="${queue[songIndex]}"]`).removeClass("playing");

			if (!displayReverse)
				songIndex = songIndex ? songIndex - 1 : queue.length - 1;
			else
				songIndex = songIndex > queue.length - 2 ? 0 : songIndex + 1;

			playSong();
			songSkipDirection = false;
		}

		function pauseSong() {
			switch (currentType) {
				case 'FILE':
					ctx.suspend();
					$("[play-pause-button]").attr("class", "bi-play");
					break;

				case 'YOUTUBE':
					player.pauseVideo();
					break;
			}
			playing = false;
		}

		function ResumeSong() {
			switch (currentType) {
				case 'FILE':
					ctx.resume();
					$("[play-pause-button]").attr("class", "bi-pause");
					break;

				case 'YOUTUBE':
					player.playVideo();
					break;
			}
			playing = true;
		}

		function showVideo() {
			$("#sng").toggle();
		}

		function isPlaying() {
			return (
				!!Array.prototype.find.call(
					document.querySelectorAll("audio,video"),
					function (elem) {
						return elem.duration > 0 && !elem.paused;
					}
				) || playing
			);
		}

		async function PlayPauseFlip() {
			if (isPlaying()) {
				fadeAudio(slider.value, 0, 200, -4.5, 10);
			} else {
				setVolume(0);
				await delay(100);
				ResumeSong();
				fadeAudio(0, slider.value, 200, 1.5, 10);
			}
		}

		//#endregion

		//#region ------------------Listeners---------------------------

		$("#fileSong").on("change", (e) => {
			const file = e.target.files[0];

			jsmediatags.read(file, {
				onSuccess: (tag) => {
					var pdata = tag.tags.picture.data;
					var format = tag.tags.picture.format;
					let base64String = "";

					for (let i = 0; i < pdata.length; i++)
						base64String += String.fromCharCode(pdata[i]);

					var uurl = `url(data:${format};base64,${window.btoa(
						base64String
					)})`;

					//document.querySelector('#pictest').style.backgroundImage
					//= `url(data:${format};base64,${window.btoa(base64String)})`

					sng = {
						name: tag.tags.title,
						link: "",
						id: "",
						playlists: [],
						favorited: false,
						type: 0,
					};

					console.log(sng);

					songs.push(sng);

					$("#tt").append(
						songBuilder(songs.length - 1, uurl, tag.tags.title, 0)
					);
				},
				onError: (err) => console.log(err),
			});
		});

		$(".progress-container").on("pointerdown",
			(e) => {
				seek_ready = false;
				$(".progress-container")[0].setPointerCapture(e.pointerId);
				setProgress(e);

				$(".progress-container").on("pointermove", setProgress);
				$(".progress-container").on("pointerup", (e) => {
					seekTo(e);
					$(".progress-container").off("pointermove", setProgress);
					seek_ready = true;
				});
				e.stopPropagation()
			});

		$(document).on("pointerenter", ".progress-container",
			(e) => {
				e.stopPropagation()
				let el = $(".float-duration");
				el.addClass("active");

				$(".progress-container").on("pointermove", (e) => {
					$("#floatDurationElapsed").html(() => {
						const width = e.target.clientWidth;
						const clickX = e.offsetX;

						t = clamp((clickX / width) * duration, 0, duration);

						let temp = Math.floor(t % 60);
						return `${Math.floor(t / 60)}:${temp < 10 ? `0${temp}` : temp
							} / ${$("#length").html()}`;
					});
					el.css("top", `${e.pageY - 35}px`);
					el.css("left", `${e.pageX - 27}px`);
				});
				$(".progress-container").on("pointerleave", (e) => {
					el.removeClass("active");
				});
			});

		$(".slidecontainer").on("pointerenter", (e) => {
			var el = $(".float-volume");
			el.addClass("active");

			$(".slidecontainer").on("pointermove", (e) => {
				$("#floatVolume").html(() => {
					const width = e.target.clientWidth;
					const clickX = e.offsetX;

					return `${slider.value}`;
				});
				el.css("top", `${e.pageY - 35}px`);
				el.css("left", `${e.pageX - 10}px`);
			});
			$(".slidecontainer").on("pointerleave", (e) => {
				el.removeClass("active");
			});
		});

		$(".togglable").on("click", (e) => {
			var el = e.target;
			el.style.opacity = el.style.opacity == 1 ? 0.3 : 1;
		});

		$('.dropdown-menu').click(function (e) { if (e.target === this) e.stopPropagation() })

		$(document).on("focus", "input", (e) => {
			is_typing = true;
			$(document).on("blur", "input", (e) => (is_typing = false));
		});

		$(document).on("click", "[data-arrow-direction]", (e) => {
			var el = e.target;
			if (el.dataset.arrowDirection) {
				el.dataset.arrowDirection = "";
				$(el).attr("class", "bi bi-arrow-bar-left");
				$(".queue-list-container").hide();
			} else {
				el.dataset.arrowDirection = "open";
				$(el).attr("class", "bi bi-arrow-bar-right");
				$(".queue-list-container").show();
			}
		});

		$(document).on("pointerenter", "[data-hover-menu]", e => {
			if (screen.width < mobileScreen)
				return

			let dis = e.target.getBoundingClientRect();
			let content = ''
			//console.log(dis)

			for (const [key, value] of Object.entries(playlists)) {
				if (key == 'favorites')
					continue
				content += `<div class="playlist" onclick="selectPlaylist(event, '${key}')" data-key="${key}" >${value['name']}</div>`
			}

			$('#hover-form-playlists').html(content)

			$('#hover-menu').show()

			let comparer = $('#hover-menu')[0].getBoundingClientRect();


			if (dis.right >= (screen.width / 2))
				$('#hover-menu').css({ "left": `${dis.right - (comparer.width + dis.width)}px`, "top": `${dis.bottom - $('#hover-menu').height()}px` })
			else
				$('#hover-menu').css({ "left": `${dis.right}px`, "top": `${dis.bottom - $('#hover-menu').height()}px` })


			//console.log(comparer.width);


			$(".dd-options>div").on("pointerenter", e => {
		//		console.log('offed')
				$('#hover-menu').hide()
				$(".dd-options>div").off("pointerenter")
			})
		})

		$(document).on("contextmenu", "[data-context]", function (e) {
			if (shift) return;
			e.preventDefault();
			hoverSongId = parseInt(this.dataset.songId);
			hoverSongElement = this;

			if (screen.width > mobileScreen)
				openContextMenu(e, this);
			else
				openMobileContextMenu(e, this)
		});

		$(document).on("click", ".bi-three-dots", (e) => {
			e['3-dots-prop'] = true;
		});

		$(document).on("mousedown", ".bi-three-dots", e => {
			e.stopPropagation()
		});

		$(document).on('click', "[data-type=\"song\"]", function (e) {
			e.stopPropagation()

			if (e['3-dots-prop']) {
				hoverSongId = +this.dataset.songId;
				hoverSongElement = this;
				if (screen.width > mobileScreen)
					openContextMenu(e, this);
				else
					openMobileContextMenu(e, this)
				return;
			}
		})

		$(document).on("mousedown", "[data-type=\"song\"]", function (e) {
			//console.log(e['propa'])
			// if (e['propa']) {
			// 	hoverSongId = +this.dataset.songId;
			// 	hoverSongElement = this;

			// 	if (screen.width > mobileScreen)
			// 		openContextMenu(e, this);
			// 	else
			// 		openMobileContextMenu(e, this)
			// 	return;
			// }
			if (e.which != 1) return;
			if (!player || !player.setVolume) return;
			let id = parseInt(this.dataset.songId);

			if (shift) {
				selecting = true;
				$(".accept-menu").show();
			}

			if (selecting) {
				$(this).toggleClass('selected')
				$(this).attr('class').includes('selected') ?
					selects.push(this.dataset.songId) :
					selects.splice(selects.findIndex(el => el == this.dataset.songId), 1)
				console.log(selects)
				$('#selected').html(selects.length + ' Selected')
				if (!selects.length) {
					selecting = false;
					$('.selected').removeClass('selected')
					$('.accept-menu').hide()
				}
				return;
			}

			$(".playing").removeClass("playing");

			clickedSong(id);
		});

		$(document).on('click', '.misc-form>.dd-options', function (e) {
			closeSongForm()
		});

		$(document).on("mousedown", '.bi-three-dots', e => e.stopPropagation())

		$('[clickable]').click(e => e.stopPropagation())
		$('[onclick]').click(e => e.stopPropagation())

		$(document).on('click', '.dropdown-menu', e => {
			if (!e['stop-prop'])
				e.stopPropagation()
		})

		$(document).on("click", ".dd-options", (e) => {
			e['stop-prop'] = true;

			// switch (e.target.getAttribute("title")) {
			// 	case "edit": {
			// 		editSong(hoverSongId);
			// 		$(".form-blur").addClass("active");
			// 		break;
			// 	}
			// 	case "play": {
			// 		shift = true;
			// 		clickedSong(hoverSongId);
			// 		shift = false;
			// 		clickedSong(songs[queue[songIndex]]);
			// 		break;
			// 	}
			// 	case "queue-next": {
			// 		shift = true;
			// 		clickedSong(hoverSongId);
			// 		shift = false;
			// 		break;
			// 	}
			// 	case "favorite": {
			// 		var bool = songs[hoverSongId].favorited;
			// 		if (bool) {
			// 			songs[hoverSongId].favorited = false;
			// 			favorites.splice(favorites.indexOf(songIndex), 1);
			// 		} else {
			// 			songs[hoverSongId].favorited = true;
			// 			favorites.push(hoverSongId);
			// 		}
			// 		break;
			// 	}
			// 	case "remove-from-playlist": {
			// 		console.log(songs[hoverSongId]);
			// 		var the_playlist = playlists[playlistIndex];
			// 		//find where deleting song is in the playlist
			// 		var ind = the_playlist.songs.indexOf(hoverSongId);
			// 		if (ind == -1) return;

			// 		var icant = (() => {
			// 			for (let l = 0; l < songs[hoverSongId].playlists.length; l++) {
			// 				if (songs[hoverSongId].playlists[l].name == the_playlist.name)
			// 					return l;
			// 			}
			// 			return -1;
			// 		})();
			// 		songs[hoverSongId].playlists.splice(icant, 1);

			// 		//splice deleting song
			// 		the_playlist.songs.splice(ind, 1);
			// 		// move positions for songs after it down (couldve just loop through
			// 		// the songs array and set everysong to its new position but this is
			// 		// more effeciant)
			// 		for (let k = ind; k < the_playlist.songs.length; k++) {
			// 			var currentSong = songs[the_playlist.songs[k]];
			// 			var findIndexForRetrival = (() => {
			// 				for (let l = 0; l < currentSong.playlists.length; l++) {
			// 					if (currentSong.playlists[l].name == the_playlist.name)
			// 						return l;
			// 				}
			// 				return -1;
			// 			})();
			// 			currentSong.playlists[findIndexForRetrival].position--;
			// 		}
			// 		the_playlist.size = the_playlist.songs.length;

			// 		hoverSongElement.remove();
			// 		break;
			// 	}
			// 	case "delete": {
			// 		//loops through every playlists that has deleting song to remove it from that playlist.
			// 		for (let i = 0; i < songs[hoverSongId].playlists.length; i++) {
			// 			const element = songs[hoverSongId].playlists[i];
			// 			//find where playlist is in playlists array
			// 			var playlistId = FindPlaylistIndexByName(element.name);

			// 			if (playlistId == -1) return;
			// 			//find where deleting song is in the playlist
			// 			var ind = playlists[playlistId].songs.indexOf(hoverSongId);
			// 			if (ind == -1) return;

			// 			console.log(element);
			// 			//splice deleting song
			// 			playlists[playlistId].songs.splice(ind, 1);
			// 			// move positions for songs after it down (couldve just loop through
			// 			// the songs array and set everysong to its new position but this is
			// 			// more effeciant)
			// 			for (let k = ind; k < playlists[playlistId].songs.length; k++) {
			// 				var currentSong = songs[playlists[playlistId].songs[k]];
			// 				var findIndexForRetrival = (() => {
			// 					for (let l = 0; l < currentSong.playlists.length; l++) {
			// 						if (currentSong.playlists[l].name == element.name) return l;
			// 					}
			// 					return -1;
			// 				})();
			// 				currentSong.playlists[findIndexForRetrival].position--;
			// 			}
			// 			if (playlists[playlistId] != null)
			// 				playlists[playlistId].size = playlists[playlistId].songs.length;
			// 		}
			// 		songs.splice(hoverSongId, 1);
			// 		hoverSongElement.remove();
			// 		loadSongs();
			// 		break;
			// 	}

			// 	case "select": {
			// 		selecting = true;
			// 		$(".accept-menu").show();
			// 		hoverSongElement.classList.toggle("selected");
			// 		if (hoverSongElement.classList.contains("selected"))
			// 			selects.push(hoverSongId);
			// 		else {
			// 			selects.splice(selects.indexOf(hoverSongId), 1);
			// 			if (!selects.length) {
			// 				selecting = false;
			// 				$(".accept-menu").hide();
			// 			}
			// 		}
			// 		break;
			// 	}

			// 	case "sel-delete": {
			// 		for (let g = 0; g < selects.length; g++) {
			// 			var sel_num = selects[g];
			// 			//if(songs[sel_num] == null) continue
			// 			if (songs[sel_num] != null && songs[sel_num].playlists != null) {
			// 				for (let i = 0; i < songs[sel_num].playlists.length; i++) {
			// 					const element = songs[sel_num].playlists[i];
			// 					//find where playlist is in playlists array
			// 					var playlistId = FindPlaylistIndexByName(element.name);

			// 					if (playlistId == -1) break;
			// 					//find where deleting song is in the playlist
			// 					var ind = playlists[playlistId].songs.indexOf(sel_num);
			// 					if (ind == -1) break;

			// 					//console.log(element);
			// 					//splice deleting song
			// 					playlists[playlistId].songs.splice(ind, 1);
			// 					// move positions for songs after it down (couldve just loop through
			// 					// the songs array and set everysong to its new position but this is
			// 					// more effeciant)
			// 					console.log(playlists[playlistId].songs);
			// 					for (
			// 						let k = ind; k < playlists[playlistId].songs.length; k++
			// 					) {
			// 						//console.log(songs[playlists[playlistId].songs[k]])
			// 						if (playlists[playlistId].songs[k] == null) continue;
			// 						var currentSong = songs[playlists[playlistId].songs[k]];
			// 						var findIndexForRetrival = currentSong.playlists.findIndex(
			// 							(el) => el.name == element.name
			// 						);

			// 						currentSong.playlists[findIndexForRetrival].position--;
			// 					}
			// 					if (playlists[playlistId] != null)
			// 						playlists[playlistId].size =
			// 							playlists[playlistId].songs.length;
			// 				}
			// 			}
			// 			songs[sel_num] = null;
			// 			$(`[data-song-id="${sel_num}"]`).remove();
			// 		}

			// 		songs = songs.filter((el) => el !== null);
			// 		selects = [];
			// 		selecting = false;
			// 		$(".accept-menu").hide();
			// 		//updateQueueHUD()
			// 		//loadSongs();

			// 		break;
			// 	}

			// 	default:
			// 		console.log(e.target.getAttribute("title"));
			// }
			contextMenu.removeClass("active");
			hoverSongElement.classList.remove("highlight");
		});

		$(document).click(e => {
			// if (e.target.dataset.context)
			// 	return;
			console.log(e.target)
			//	if(!e['3-dots-propa'])
			$('.dropdown-menu').hide()
			// $('.highlight').removeClass('hightlight')
			// if (selecting) {
			// 	selecting = false;
			// 	selects = []
			// 	$('.selected').removeClass('selected')
			// 	$('.accept-menu').hide()
			// }
		});

		document.addEventListener("keydown", (e) => {
			if (is_typing) return;
			switch (e.keyCode) {
				case 37: {
					if (shift) {
						prevSong();
					} else {
						Etime -= 5
						player.seekTo(Etime);
					}
					break;
				}
				case 39: {
					if (shift) {
						nextSong();
					} else {
						Etime += 5
						player.seekTo(Etime);
					}
					break;
				}
				case 38: {
					slider.value = parseInt(slider.value) + 5;
					player.setVolume(slider.value);
					break;
				}
				case 40: {
					slider.value -= 5;
					player.setVolume(slider.value);
					break;
				}
				case 32: {
					e.preventDefault();
					PlayPauseFlip();
					break;
				}
				case 17: {
					e.preventDefault();
					shift = true;
					break;
				}
				case 16: {
					e.preventDefault();
					shift2 = true;
					break;
				}
				// case 176: 
				// 	nextSong()
				// 	break;
				// case 179:
				// 	PlayPauseFlip()
				// 	break;
				// case 177:
				// 	prevSong();
				// 	break;
			}
			//	console.log(e.keyCode)
		});

		$(document).on("keyup", (e) => {
			switch (e.keyCode) {
				case 17: {
					e.preventDefault();
					shift = false;
					break;
				}
				case 16: {
					e.preventDefault();
					shift2 = false;
					break;
				}
			}
		});

		// document.addEventListener("dragover", (event) => {
		// 	event.stopPropagation();
		// 	event.preventDefault();
		// 	event.dataTransfer.dropEffect = "copy";
		// });

		// document.addEventListener("drop", (event) => {
		// 	event.stopPropagation();
		// 	event.preventDefault();
		// 	DragSong(event.dataTransfer.files);
		// });

		window.addEventListener(
			"beforeunload",
			function (e) {
				//AutoSave();
			},
			false
		);

		window.addEventListener('resize', e => {
			console.log(screen.width)
			setupSwap()
		})

		var hides = [];

		function debounce(cb, delay = 1000) {
			let timeout;

			return (...args) => {
				clearTimeout(timeout)
				timeout = setTimeout(() => {
					cb(...args)
				}, delay)
			}
		}

		var doit = debounce(text => {
			hides.forEach(el => $('#song' + el).show())
			$('.songElements>*:visible').filter((i, el) => {
				let bool = !songs[+el.dataset.songId].name.toLowerCase().includes(text.toLowerCase())
				if (bool)
					hides.push(+el.dataset.songId)

				return bool;
			}).hide()
		}, 500)

		$('#search').on('input', (e) => {
			doit(e.target.value)
		})

		// $('#m-search').on('input', (e) => {
		// 	updateScope(songScope.filter((el) =>
		// 		songs[el].name.toLowerCase().includes(e.target.value.toLowerCase())))
		// })

		//$('.song-bar').click(e => e.stopPropagation())

		let query = '.song-bar';

		$(query).on('pointerdown', function (e) {
			let pointX = e.pageX;
			let pointY = e.pageY;
			//console.log(pointY)
			$(query)[0].setPointerCapture(e.pointerId);

			let moveEnough = (e2) => {
				let gestureX = e2.offsetX - pointX;
				let gestureY = e2.pageY - pointY;
				//console.log(gestureX)
				//console.log(e2.pageY)
				if (gestureX > 70) {
					console.log('left swipe that')
					prevSong()
					exit();
				}
				if (gestureX < -70) {
					console.log('right swipe that')
					nextSong(true, true)
					exit();
				}
				if (gestureY < -40) {
					console.log('up swipe that')
					$('#sb1').toggle()
					$('#sb2').toggle()
					exit();
				}
			}

			let exit = () => {
				$(query).off('pointermove', moveEnough)
				$(query).off('pointerup', exit)
			}

			$(query).on('pointermove', moveEnough);
			$(query).on('pointerup', exit)
			e.stopPropagation()
		})

		slider.oninput = function () {
			setVolume(this.value);
		};
		//#endregion
	</script>
</body>

</html>